<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>å´éŒ„å½±ç‰‡</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

<style>
  html,body{height:100%;margin:0;background:#fff;color:#3b3f44;font-family:"Manrope","Noto Sans TC",sans-serif;}
  
  .outer{
    width:100vw; height:100vh; display:grid; place-items:center;
  }
  .stage{
    width:1366px; height:1024px; position:relative;
    transform: scale(calc(var(--vh, 1vh) * 100 / 1024 * 0.9)); 
    background: #fff;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }

  h2 { font-size: 36px; font-weight: 900; margin-bottom: 20px; }
  
  .video-container {
    width: 800px; height: 450px; background: #000; border-radius: 20px;
    overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    margin-bottom: 40px; display: flex; align-items: center; justify-content: center;
  }
  
  video { width: 100%; height: 100%; object-fit: contain; }

  .btns { display: flex; gap: 20px; }

  button, a.btn-link {
    appearance:none; border:0; border-radius:20px;
    padding:18px 40px; font-size:22px; font-weight:800;
    cursor:pointer; text-decoration:none;
    box-shadow:0 6px 0 rgba(0,0,0,.15); transition:.15s;
    display:inline-flex; align-items:center; justify-content:center;
    min-width: 200px;
  }
  .primary { background:#bfefff; color:#1f2a33; }
  .secondary { background:#fff; border:2px solid #eee; color:#555; box-shadow:0 6px 0 #ddd; }
  button:hover, a.btn-link:hover{ transform:translateY(-2px); box-shadow:0 10px 0 rgba(0,0,0,.15); }
</style>
</head>

<body>
<div class="outer">
  <div class="stage">
    <h2>ğŸ“¸ æ‹æ”éç¨‹å´éŒ„</h2>
    <div class="video-container">
      <video id="playback" controls autoplay playsinline></video>
    </div>
    <div class="btns">
      <a id="download-btn" class="btn-link primary" href="#" download>â¬‡ ä¸‹è¼‰å½±ç‰‡</a>
      <button class="secondary" onclick="goBack()">â†© å›ä¸Šä¸€é </button>
    </div>
  </div>
</div>

<script>
  function setVH(){
    document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
  }
  window.addEventListener('resize', setVH);
  setVH();

  const videoEl = document.getElementById('playback');
  const dlBtn = document.getElementById('download-btn');

  // è³‡æ–™åº«è®€å– (v3)
  function getVideoFromDB() {
    return new Promise((resolve, reject) => {
      // â˜…â˜…â˜… é—œéµï¼šé€™è£¡ä¹Ÿè¦ç”¨ç‰ˆæœ¬ 3 â˜…â˜…â˜…
      const request = indexedDB.open("PhotoboothDB", 3);
      
      request.onsuccess = e => {
        const db = e.target.result;
        // å¦‚æœè³‡æ–™åº«æ˜¯ç©ºçš„æˆ–æ²’æœ‰ videos è¡¨
        if(!db.objectStoreNames.contains("videos")) { 
          resolve(null); return; 
        }
        
        const tx = db.transaction("videos", "readonly");
        const req = tx.objectStore("videos").get("latest");
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
      };
      
      // å¦‚æœå› ç‚ºç‰ˆæœ¬ä¸åˆæˆ–å…¶ä»–åŸå› å¤±æ•—
      request.onerror = (e) => {
        console.error("DB Error", e);
        reject();
      };
    });
  }

  async function init() {
    try {
      const blob = await getVideoFromDB();
      
      if(blob) {
        const url = URL.createObjectURL(blob);
        videoEl.src = url;
        
        dlBtn.href = url;
        const mime = localStorage.getItem('booth_video_mime') || 'video/webm';
        const ext = mime.includes('mp4') ? 'mp4' : 'webm';
        dlBtn.download = `photobooth_video_${Date.now()}.${ext}`;
      } else {
        alert('æ‰¾ä¸åˆ°å½±ç‰‡è³‡æ–™ï¼Œè«‹é‡æ–°æ‹æ”ï¼');
      }
    } catch(e) {
      console.error(e);
      alert('è®€å–å½±ç‰‡è³‡æ–™åº«å¤±æ•—ï¼Œè«‹é‡æ•´é é¢é‡è©¦');
    }
  }

  function goBack() {
    location.href = 'booth-export.html';
  }

  init();
</script>
</body>
</html>