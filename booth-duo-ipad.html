<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>æ‹è²¼ï½œå‹•ä½œå¼•å°æ¨¡å¼ (åˆæˆç‰ˆ)</title>

<style>
html,body{
  margin:0; background:#000; overflow:hidden;
  overscroll-behavior:none; touch-action:manipulation;
  font-family:"Noto Sans TC",system-ui;
}
*{user-select:none;-webkit-user-select:none;}

/* ä¿®æ”¹ï¼šå¼·åˆ¶å…¨è¢å¹•ï¼Œä¸ç•™é»‘é‚Š */
.stage {
  width: 100vw;   /* è¦–çª—å¯¬åº¦ 100% */
  height: 100vh;  /* è¦–çª—é«˜åº¦ 100% */
  position: relative;
  background: #000;
  overflow: hidden; /* é˜²æ­¢æ²è»¸å‡ºç¾ */
}

#composite-canvas {
  width: 100%;
  height: 100%;
  /* é—œéµï¼šcover æœƒè®“ç•«é¢å¡«æ»¿æ•´å€‹è¢å¹•ï¼Œå¯èƒ½æœƒè£åˆ‡æ‰ä¸€é»é‚Šç·£ï¼Œä½†çµ•å°ä¸æœƒæœ‰é»‘é‚Š */
  object-fit: cover; 
  display: block;
}
#cam, #char-video {
  position: absolute;
  top: 0; left: 0;
  width: 1px; height: 1px;
  opacity: 0; 
  pointer-events: none;
  z-index: -1;
}

/* â˜… ä¿®æ”¹é»ï¼šå³å´åŠèº«å¼•å°æ¡† (Overlay) */
/* â˜… ä¿®æ”¹é»ï¼šå³å´åŠèº«å¼•å°æ¡† (äººå½¢åœ–ç¤ºé¢¨æ ¼) */
.guide-box {
  position: absolute;
  bottom: 0; 
  right: 20%; /* ä½ç½® */
  width: 500px; /* èº«é«”å¯¬åº¦ */
  height: 60%;  /* èº«é«”é«˜åº¦ */
  
  /* ç•«å‡ºèº«é«”ï¼šä¸Šæ–¹åœ“å¼§ï¼Œä¸‹æ–¹ç›´è§’ */
  border: 4px dashed rgba(255, 255, 255, 0.3); /* æ·¡æ·¡çš„ç™½è‰²è™›ç·š */
  border-bottom: none; 
  border-radius: 250px 250px 0 0; /* è®“é ‚éƒ¨è®ŠæˆåŠåœ“æ‹±å½¢ */
  
  pointer-events: none; 
  z-index: 50; 
  /* ç§»é™¤åŸæœ¬çš„é™°å½±ï¼Œè®“ç•«é¢æ›´æ¸…çˆ½ */
  box-shadow: none;
}

/* â˜… ä¿®æ”¹é»ï¼šåˆ©ç”¨å½å…ƒç´ ç•«å‡ºã€Œé ­éƒ¨ã€ */
.guide-box::before {
  content: ""; /* æŠŠåŸæœ¬çš„æ–‡å­—æ‹¿æ‰ï¼Œåªç•™å½¢ç‹€ */
  position: absolute;
  
  /* é ­éƒ¨çš„å¤§å°èˆ‡ä½ç½® */
  width: 180px; 
  height: 180px;
  top: -220px; /* å¾€ä¸Šæ¨ï¼Œèˆ‡èº«é«”åˆ†é–‹ */
  left: 50%;
  transform: translateX(-50%); /* ç½®ä¸­ */
  
  /* é ­éƒ¨çš„æ¨£å¼ */
  border: 4px dashed rgba(255, 255, 255, 0.3); /* è·Ÿèº«é«”ä¸€æ¨£æ·¡æ·¡çš„ */
  border-radius: 50%; /* åœ“å½¢ */
}

/* â˜… ä¿®æ”¹é»ï¼šèƒ¸å‰æ‰‹å‹¢æç¤ºå€ (è®Šæ·¡ã€è®Šæ–‡å­—ç‚ºä¸») */
.hand-area {
  position: absolute;
  top: 10%; /* åœ¨èº«é«”æ¡†æ¡†å…§çš„ç›¸å°ä½ç½®ï¼Œå¤§ç´„èƒ¸å£ */
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  height: 200px;
  
 /* é€™è£¡æ”¹æˆ noneï¼Œå°±çœ‹ä¸åˆ°æ¡†æ¡†äº† */
  border: none; 
  background: transparent;
  
  display: flex; justify-content: center; align-items: center;
}

.hand-area span {
  /* æ–‡å­—æ¨£å¼ï¼šæ·¡æ·¡çš„ç™½å­— */
  background: rgba(0, 0, 0, 0.2); /* æ¥µæ·¡çš„é»‘åº•è¥¯æ‰˜æ–‡å­— */
  padding: 8px 20px;
  border-radius: 50px;
  color: rgba(255, 255, 255, 0.7); /* æ·¡æ·¡çš„ç™½è‰² */
  font-weight: 500; /* å­—é«”ä¸ç”¨å¤ªç²— */
  font-size: 24px;
  letter-spacing: 2px;
}

/* å·¦ä¸Šè§’ç‹€æ…‹åˆ— */
.top-status {
  position: absolute; top: 30px; left: 30px; z-index: 100;
  display: flex; align-items: center; gap: 15px;
  background: rgba(0, 0, 0, 0.6);
  padding: 15px 30px; border-radius: 50px;
  backdrop-filter: blur(10px);
  color: #fff; font-weight: 900; font-size: 32px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  transition: 0.3s;
}

/* éŒ„å½±ç´…é» */
.rec-dot {
  width: 24px; height: 24px; background: #ff3b30; border-radius: 50%;
  display: none; 
}
.recording .rec-dot { display: block; animation: pulse 1s infinite; }
.recording { border: 2px solid rgba(255, 59, 48, 0.5); background: rgba(50, 0, 0, 0.6); }

@keyframes pulse { 0%{opacity:1;} 50%{opacity:0.4;} 100%{opacity:1;} }

/* é–ƒå…‰ç‡ˆæ•ˆæœ */
.flash{
  position:absolute; inset:0; background:#fff; opacity:0; transition:.12s; z-index: 60; pointer-events: none;
}

/* æº–å‚™ç•«é¢é®ç½© */
.loading{
  position:absolute; inset:0; display:flex; flex-direction: column;
  justify-content: center; align-items: center; gap: 20px;
  background:rgba(0,0,0,.7); color:#fff;
  opacity:0; transition:.2s; z-index: 70; pointer-events: none;
  backdrop-filter: blur(5px);
}
.loading h2 { font-size: 60px; margin: 0; font-weight: 900; }
.loading p { font-size: 32px; margin: 0; opacity: 0.9; }
.show{opacity:1; pointer-events:auto;}

/* é–‹å§‹æŒ‰éˆ• */
.startBtn{
  position:absolute; inset:0; margin:auto; width:420px; height:120px;
  font-size:32px; font-weight:900; border-radius:60px; border:0; cursor:pointer;
  background: #bfefff; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  transition: transform 0.2s; z-index: 80;
}
.startBtn:active { transform: scale(0.95); }
</style>
</head>

<body>
<div class="stage">
  <canvas id="composite-canvas" width="1920" height="1080"></canvas>
  
  <div class="guide-box">
    <div class="hand-area">
      <span>æ‰‹æ”¾èƒ¸å‰</span>
    </div>
  </div>

  <video id="cam" autoplay playsinline muted></video>
  <video id="char-video" loop muted playsinline crossorigin="anonymous"></video>
  <img id="char-img" style="display:none;" crossorigin="anonymous">
  
  <div id="status-bar" class="top-status">
    <div class="rec-dot"></div>
    <span id="status-text">æº–å‚™ä¸­</span>
  </div>

  <div id="flash" class="flash"></div>

  <div id="loading" class="loading">
    <h2 id="msg-title">æº–å‚™ä¸­...</h2>
    <p id="msg-sub">è«‹ç¨å€™</p>
  </div>

  <button id="start" class="startBtn">ğŸ“¸ é–‹å§‹å‹•æ…‹æ‹è²¼</button>
</div>

<script>
/* =====================
   0. è³‡æ–™åº«å·¥å…·
===================== */
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("PhotoboothDB", 3);
    request.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains("videos")) db.createObjectStore("videos");
    };
    request.onsuccess = e => resolve(e.target.result);
    request.onerror = e => { console.error("DB Error", e); reject(e); };
  });
}

async function saveClipToDB(blob, index) {
  const db = await openDB();
  return new Promise((resolve) => {
    const tx = db.transaction("videos", "readwrite");
    const store = tx.objectStore("videos");
    store.put(blob, `clip_${index}`);
    tx.oncomplete = () => resolve();
    tx.onerror = () => resolve(); 
  });
}

async function saveFullVideoToDB(blob) {
  const db = await openDB();
  return new Promise((resolve) => {
    const tx = db.transaction("videos", "readwrite");
    const store = tx.objectStore("videos");
    store.put(blob, "latest");
    tx.oncomplete = () => resolve();
  });
}

/* =====================
   1. è¨­å®šèˆ‡æµç¨‹
===================== */
let currentRole = 'æ·˜æ°£å¥³'; 
try {
  const savedData = JSON.parse(localStorage.getItem('photobooth_template'));
  if (savedData && savedData.role) {
    currentRole = savedData.role;
  }
} catch (e) {
  console.log("è®€å–è§’è‰²å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼");
}

const SEQUENCE = [
  {
    title: 'å‹•ä½œ 1',
    sub: 'è«‹è·Ÿè‘—å°äººåšï¼šé›™æ‰‹é¢å°é¢',
    type: 'image', 
    src: `video/${currentRole}_1.png` 
  },
  {
    title: 'å‹•ä½œ 2',
    sub: 'ä¸Šä¸‹å‹•é›™æ‰‹ï¼Œæ‰‹æŒ‡éˆå‹•',
    type: 'video',
    src: `video/${currentRole}_2.webm`
  },
  {
    title: 'å‹•ä½œ 3',
    sub: 'æœ€å¾Œä¸€å¼µï¼šç¿¹èµ·å°æ‹‡æŒ‡',
    type: 'video',
    src: `video/${currentRole}_3.webm`
  }
];

const cam = document.getElementById('cam');
const charVideo = document.getElementById('char-video');
const canvas = document.getElementById('composite-canvas');
const ctx = canvas.getContext('2d');
const charImg = document.getElementById('char-img');
let currentMediaType = 'video'; 

const flash = document.getElementById('flash');
const loading = document.getElementById('loading');
const msgTitle = document.getElementById('msg-title');
const msgSub = document.getElementById('msg-sub');
const startBtn = document.getElementById('start');
const statusBar = document.getElementById('status-bar');
const statusText = document.getElementById('status-text');

const sleep = ms => new Promise(r=>setTimeout(r,ms));
let stream = null;
let canvasStream = null;
let fullRecorder = null;
let fullChunks = [];
let shooting = false;
let animationId = null;

/* =====================
   2. ç•«é¢åˆæˆé‚è¼¯
===================== */
function startCanvasLoop() {
  canvas.width = 1920;
  canvas.height = 1080;

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. ç¹ªè£½ç›¸æ©Ÿ
    ctx.save();
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    
    if (cam.readyState >= 2) {
      ctx.drawImage(cam, 0, 0, canvas.width, canvas.height);
    }
    ctx.restore();

    // 2. ç¹ªè£½è§’è‰²
// 2. ç¹ªè£½è§’è‰²
    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ èª¿æ•´é€™è£¡çš„æ•¸å­— â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    const scale = 0.85;       // å¤§å°ï¼š0.85 ä»£è¡¨ä½”ç•«é¢é«˜åº¦çš„ 85% (æ•¸å­—è¶Šå°äººè¶Šå°)
    const marginLeft = 90;    // æ°´å¹³ä½ç½®ï¼šè·é›¢å·¦é‚Šç•Œå¤šå°‘åƒç´  (æ•¸å­—è¶Šå¤§è¶Šå¾€å³)
    const marginBottom = -170; // å‚ç›´ä½ç½®ï¼šè·é›¢åº•éƒ¨å¤šå°‘åƒç´  (æ­£æ•¸å¾€ä¸Šæµ®ï¼Œè² æ•¸å¾€ä¸‹æ²‰)
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    const charH = canvas.height * scale; 
    // è¨ˆç®— Y åº§æ¨™ (ç•«å¸ƒé«˜åº¦ - è§’è‰²é«˜åº¦ - åº•éƒ¨ç•™ç™½)
    const y = canvas.height - charH - marginBottom;
    
    // çµ±ä¸€è¨­å®š X åº§æ¨™
    const x = marginLeft;

    if (currentMediaType === 'video') {
       if (charVideo.readyState >= 2 && !charVideo.paused && !charVideo.ended && charVideo.currentTime > 0) {
          const ratio = charVideo.videoWidth / charVideo.videoHeight;
          const charW = charH * ratio; // æ ¹æ“šé«˜åº¦è‡ªå‹•ç®—å‡ºå¯¬åº¦ï¼Œä¿æŒæ¯”ä¾‹
          ctx.drawImage(charVideo, x, y, charW, charH);
       }
    } 
    else if (currentMediaType === 'image') {
       if (charImg.complete && charImg.naturalHeight !== 0) {
          const ratio = charImg.naturalWidth / charImg.naturalHeight;
          const charW = charH * ratio;
          ctx.drawImage(charImg, x, y, charW, charH);
       }
    }
    animationId = requestAnimationFrame(draw);
  }
  
  draw();
}

async function startCamera(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 30 } },
      audio: false
    });
    cam.srcObject = stream;
    await cam.play();
    
    startCanvasLoop();
    canvasStream = canvas.captureStream(30);
    
  } catch (err) {
    console.error("ç›¸æ©Ÿå¤±æ•—", err);
    alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ");
  }
}

/* =====================
   3. æµç¨‹æ§åˆ¶
===================== */

function setStepUI(index) {
  const step = SEQUENCE[index];
  
  currentMediaType = step.type;

  if (step.type === 'image') {
    charImg.src = step.src;
    charVideo.pause();
  } else {
    if (charVideo.getAttribute('src') !== step.src) {
      charVideo.src = step.src;
      charVideo.play().catch(e => console.log('Autoplay blocked'));
    } else {
      charVideo.play();
    }
  }
  
  msgTitle.innerHTML = step.title;
  msgSub.textContent = step.sub;
  loading.classList.add('show');
}

async function countdown(){
  loading.classList.remove('show'); 
  statusBar.classList.remove('recording');
  
  for(let i=5; i>0; i--){
    statusText.textContent = `æº–å‚™... ${i}`;
    await sleep(1000);
  }
}

function shutterFX(){
  flash.classList.add('show');
  setTimeout(()=>flash.classList.remove('show'), 150);
}

function recordClip(duration = 2500) {
  return new Promise((resolve) => {
    const chunks = [];
    let mimeType = 'video/webm;codecs=vp9';
    if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm';
    if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/mp4';

    const recorder = new MediaRecorder(canvasStream, { mimeType, videoBitsPerSecond: 5000000 });
    
    recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
    recorder.onstop = () => resolve(new Blob(chunks, { type: mimeType }));
    
    recorder.start();
    setTimeout(() => recorder.stop(), duration);
  });
}

function startFullRecording(){
  if(!canvasStream) return;
  fullChunks = [];
  try {
    fullRecorder = new MediaRecorder(canvasStream, { videoBitsPerSecond: 5000000 });
    fullRecorder.ondataavailable = e => { if(e.data.size>0) fullChunks.push(e.data); };
    fullRecorder.start();
  } catch(e) { console.error(e); }
}

function stopFullRecording(){
  return new Promise((resolve) => {
    if(!fullRecorder || fullRecorder.state === 'inactive') { resolve(); return; }
    fullRecorder.onstop = async () => {
      const blob = new Blob(fullChunks, { type: fullRecorder.mimeType });
      localStorage.setItem('booth_video_mime', fullRecorder.mimeType);
      await saveFullVideoToDB(blob);
      resolve();
    };
    fullRecorder.stop();
  });
}

/* =====================
   4. ä¸»æµç¨‹
===================== */
async function shoot(){
  if(shooting) return;
  shooting = true;
  startBtn.style.display = 'none';

  if(!stream) await startCamera();
  
  await sleep(500);
  startFullRecording();

  for(let i=0; i<3; i++) {
    statusText.textContent = `å‹•ä½œ ${i+1}`;
    setStepUI(i);
    await sleep(3000); 
    
    await countdown(); 
    
    shutterFX();
    statusBar.classList.add('recording');
    statusText.textContent = "éŒ„å½±ä¸­";
    
    const clipBlob = await recordClip(2500);
    await saveClipToDB(clipBlob, i);
    
    statusBar.classList.remove('recording');
  }
  
  msgTitle.textContent = 'æ‹æ”å®Œæˆ';
  msgSub.textContent = 'è™•ç†ä¸­...';
  loading.classList.add('show');
  
  await stopFullRecording();

  localStorage.setItem('photobooth_job', JSON.stringify({ done: true, time: Date.now() }));
  await sleep(1000);
  location.href = 'booth-export.html';
}

startBtn.onclick = async ()=>{
  try{ await shoot(); }
  catch(err){ console.error(err); alert('éŒ¯èª¤'); location.reload(); }
};

startCamera();

(function(){
  function setVH(){ document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px'); }
  window.addEventListener('resize', setVH); setVH();
})();
</script>
</body>
</html>