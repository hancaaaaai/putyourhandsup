<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>20ç¨®çµæœç•™è¨€ç‰†</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

  /* === è‡ªè¨‚é¼ æ¨™æ¨£å¼ === */
  /* éš±è—é è¨­é¼ æ¨™ï¼ŒåŒ…å«ç•™è¨€ç‰†çš„å°äººã€è¼¸å…¥æ¡†ç­‰ */
  body, button, input, .person, .zone, .ui-layer { 
    cursor: none !important; 
  }

  #fake-cursor {
    /* â˜…â˜…â˜… é€™è£¡æ§åˆ¶å¤§å°ï¼Œæƒ³è®Šå¤§æ”¹é€™è£¡çš„æ•¸å­— â˜…â˜…â˜… */
    width: 100px; 
    height: 100px;
    
    position: fixed; top: 0; left: 0; 
    pointer-events: none; z-index: 99999; will-change: transform;
  }
  
  #fake-cursor-img {
    width: 100%; height: 100%;
    background-image: url('cursor.png'); /* ç¢ºèªåœ–ç‰‡è·¯å¾‘ */
    background-size: contain; background-repeat: no-repeat;
    transform-origin: center 80%;
  }
  
  #fake-cursor.is-clicking #fake-cursor-img {
    background-image: url('cursor-click.png'); /* ç¢ºèªåœ–ç‰‡è·¯å¾‘ */
    transform: rotate(-5deg);
  }
  * { box-sizing: border-box; }
  body { 
    font-family: "Manrope", "Noto Sans TC", sans-serif; 
    margin: 0; padding: 0; 
    background: #f0f0f0; 
    height: 100vh; width: 100vw;
    overflow: hidden; 
  }

  /* === ä¸»å®¹å™¨ === */
  .viewport {
    width: 100%; height: 100%;
    position: relative;
    background-color: #fdfbf7;
    background-image: radial-gradient(#ddd 1px, transparent 1px);
    background-size: 30px 30px;
    display: flex; justify-content: center; align-items: center; 
    padding-bottom: 120px; /* é€™è£¡è¦é¿é–‹è®Šé«˜çš„åº•éƒ¨è¼¸å…¥åˆ— */
  }

  /* === å»£å ´ç¶²æ ¼ === */
  .plaza {
    width: 95vw; height: 80vh; /*ç¨å¾®ç¸®å°ä¸€é»é«˜åº¦çµ¦åº•éƒ¨*/
    display: grid; 
    grid-template-columns: repeat(5, 1fr); 
    grid-template-rows: repeat(4, 1fr);
    gap: 12px; 
  }

  /* === å€åŸŸæ¨£å¼ === */
  .zone {
    position: relative;
    border: 1px dashed rgba(0,0,0,0.15); 
    border-radius: 12px;
    background: rgba(255,255,255,0.4);
    transition: all 0.2s;
  }
  .zone:hover { 
    background: rgba(255,255,255,0.8); 
    border-color: rgba(0,0,0,0.3);
  }
  .zone-label {
    position: absolute; 
    font-size: 16px; font-weight: 900; color: #555; opacity: 0.4;
    bottom: 8px; right: 10px;
    pointer-events: none; z-index: 0;
  }

  /* === å°äººæ¨£å¼ (å»èƒŒç‰ˆ) === */
  .person {
    position: absolute;
    display: flex; flex-direction: column; align-items: center;
    width: 80px; 
    z-index: 10;
    transition: transform 0.2s, z-index 0.2s;
    cursor: pointer;
  }
  .person:hover { z-index: 100 !important; transform: scale(1.2); }

  /* é€æ˜å®¹å™¨ */
  .avatar-video-box {
    width: 80px; height: 80px; 
    background: transparent; 
    border: none; 
    border-radius: 0; 
    box-shadow: none; 
    
    display: flex; justify-content: center; align-items: center;
    position: relative;
    overflow: visible; 
  }
  
  /* å½±ç‰‡æœ¬é«” */
  .avatar-video-box video {
    width: 100%; height: 100%;
    object-fit: contain; 
    transform: scale(1); 
  }

  .bubble {
    background: #fff; padding: 4px 8px; border-radius: 8px;
    font-size: 13px; font-weight: 700; color: #333;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 0px; 
    position: relative;
    max-width: 120px; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    opacity: 0.95;
    text-align: center;
  }
  .person:hover .bubble { white-space: normal; overflow: visible; z-index: 101; min-width: 90px;}
  .bubble::after {
    content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
    border-width: 4px 4px 0; border-style: solid; border-color: #fff transparent transparent;
  }

  /* === UI å›ºå®šå±¤ (åº•éƒ¨åŠ å¤§) === */
  .ui-layer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 500;
  }
  .ui-layer > * { pointer-events: auto; }

  /* â˜…â˜…â˜… ä¿®æ”¹é‡é»ï¼šåŠ é«˜åº•éƒ¨è¼¸å…¥åˆ— â˜…â˜…â˜… */
  .input-bar {
    position: absolute; bottom: 0; left: 0; width: 100%; 
    height: 120px; /* å¾ 70px åŠ å¤§åˆ° 120px */
    background: rgba(255,255,255,0.9); padding: 0 40px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    display: flex; align-items: center; gap: 20px; 
    backdrop-filter: blur(8px);
    border-top: 1px solid #eee;
  }
  
  /* æ¨™ç±¤å­—é«”åŠ å¤§ */
  .role-badge { 
    background: #333; color: #fff; padding: 8px 18px; border-radius: 30px; 
    font-weight: bold; white-space: nowrap; font-size: 18px; /* åŠ å¤§ */
  }
  
  /* è¼¸å…¥æ¡†åŠ å¤§ */
  input { 
    flex-grow: 1; padding: 15px 25px; 
    font-size: 24px; /* å­—é«”åŠ å¤§ */
    border: 3px solid #eee; border-radius: 60px; outline: none; 
    height: 70px; /* è¼¸å…¥æ¡†é«˜åº¦ */
  }
  
  /* é€å‡ºæŒ‰éˆ•åŠ å¤§ */
  button.send { 
    padding: 15px 35px; border-radius: 60px; border: 0; 
    background: #ffdd00; font-weight: 900; 
    font-size: 22px; /* å­—é«”åŠ å¤§ */
    cursor: pointer; 
  }
  
  /* é¦–é æŒ‰éˆ•åŠ å¤§ */
  button.home {
    padding: 15px; border-radius: 50%; border: 3px solid #eee; 
    background: #fff; cursor: pointer; 
    font-size: 24px; /* åŠ å¤§ */
    width: 70px; height: 70px;
    display: flex; align-items: center; justify-content: center;
  }

  .sidebar {
    position: absolute; top: 0; right: 0; width: 360px; height: 100%;
    background: #fff; box-shadow: -5px 0 30px rgba(0,0,0,0.1);
    transform: translateX(320px); 
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    display: flex; flex-direction: column;
  }
  .sidebar:hover { transform: translateX(0); }
  
  .sidebar-tab {
    position: absolute; left: 0; top: 50%; transform: translateY(-50%) translateX(-100%);
    background: #333; color: #fff;
    padding: 20px 8px; border-radius: 10px 0 0 10px;
    writing-mode: vertical-lr; font-weight: bold; letter-spacing: 2px;
    cursor: pointer; box-shadow: -4px 0 10px rgba(0,0,0,0.1);
  }
  
  .sidebar-content { padding: 30px; overflow-y: auto; height: 100%; }
  .chart-container { position: relative; width: 100%; height: 250px; margin-bottom: 30px; }
  h2 { font-size: 20px; font-weight: 900; margin-bottom: 20px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;}
  
  .ranking-list { list-style: none; padding: 0; margin: 0; }
  .rank-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; }
  .rank-num { font-size: 18px; font-weight: 900; color: #ccc; margin-right: 15px; width: 30px; }
  .rank-item:nth-child(1) .rank-num { color: #ffd700; } 
  .rank-item:nth-child(2) .rank-num { color: #c0c0c0; } 
  .rank-item:nth-child(3) .rank-num { color: #cd7f32; } 
  .rank-name { font-weight: 700; flex-grow: 1; text-align: left; font-size: 15px; }
  .rank-count { font-weight: 900; color: #ff8a80; background: #fff0f0; padding: 4px 8px; border-radius: 8px; font-size: 13px;}

  #secret-btn {
    position: fixed; top: 0; left: 0; width: 100px; height: 100px; z-index: 9999;
    background: transparent; cursor: default; 
  }
</style>
</head>
<body>

  <div class="viewport">
    <div class="plaza" id="plaza"></div>
  </div>

  <div id="secret-btn" onclick="handleSecretClick()"></div>

  <div class="ui-layer">
    <div class="input-bar">
      <button class="home" onclick="location.href='index.html'">ğŸ </button>
      <div class="role-badge">æˆ‘æ˜¯ï¼š<span id="my-role">æœªçŸ¥</span></div>
      <input type="text" id="msg-input" placeholder="ç•™å€‹è¨€å§..." maxlength="20">
      <button class="send" onclick="addMessage()">é€å‡º</button>
    </div>

    <div class="sidebar">
      <div class="sidebar-tab">ğŸ“Š æ•¸æ“šåˆ†æ</div>
      <div class="sidebar-content">
        <h2>å„è§’è‰²åˆ†ä½ˆ</h2>
        <div class="chart-container"><canvas id="roleChart"></canvas></div>
        <h2>ğŸ† é¸æ“‡æœ€å¤š TOP 3</h2>
        <ul id="top3-list" class="ranking-list"></ul>
      </div>
    </div>
  </div>
<div id="fake-cursor"><div id="fake-cursor-img"></div></div>
<script>
  // ==========================================
  // 1. è¨­å®šï¼š20 ç¨®çµæœåç¨± (å°æ‡‰æ ¼å­)
  // ==========================================
  const roleList = [
    "æ·˜æ°£", "å¹½é»˜", "æ´»æ½‘", "å¤§æ–¹",
    "å®³ç¾", "å†·éœ", "æ–‡éœ", "æ²‰ç©©",
    "æº«æŸ”", "å–„è‰¯", "è€å¿ƒ", "æ¨‚è§€",
    "å‹‡æ•¢", "è‡ªä¿¡", "æœæ–·", "ç¨ç«‹",
    "æ•éŠ³", "ç´°å¿ƒ", "è°æ˜", "è¬¹æ…"
  ];

  // ç”Ÿæˆæ ¼å­
  const plaza = document.getElementById('plaza');
  roleList.forEach((role, i) => {
    const zone = document.createElement('div');
    zone.className = 'zone';
    zone.id = `zone-${i}`;
    
    const label = document.createElement('div');
    label.className = 'zone-label';
    label.textContent = role;
    zone.appendChild(label);
    plaza.appendChild(zone);
  });

  // ==========================================
  // 2. éš±è—æ¸…ç©ºé‚è¼¯ (é€£é» 5 ä¸‹)
  // ==========================================
  let secretClicks = 0;
  let secretTimer = null;

  function handleSecretClick() {
    secretClicks++;
    clearTimeout(secretTimer);
    secretTimer = setTimeout(() => { secretClicks = 0; }, 500);

    if(secretClicks >= 5) {
      if(confirm('ã€ç®¡ç†å“¡æ¨¡å¼ã€‘\n\nç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç•™è¨€å—ï¼Ÿ')) {
        localStorage.removeItem('guestbook_messages');
        alert('å·²æ¸…ç©º');
        location.reload();
      }
      secretClicks = 0;
    }
  }

  // ==========================================
  // 3. è³‡æ–™èˆ‡æ¸²æŸ“
  // ==========================================
  const myData = JSON.parse(localStorage.getItem('photobooth_template') || '{}');
  const myRole = myData.role || 'æ·˜æ°£å¥³'; 
  document.getElementById('my-role').textContent = myRole;

  let messages = JSON.parse(localStorage.getItem('guestbook_messages') || '[]');
  
  // â˜…â˜…â˜… ä¿®æ”¹é‡é»ï¼šé è¨­ 3 å€‹ç•™è¨€ â˜…â˜…â˜…
  if(messages.length === 0) {
    messages = [
      { role: 'æ·˜æ°£ç”·', text: 'æˆ‘æ˜¯æ·˜æ°£é¬¼ï¼', time: '10:00' },
      { role: 'æº«æŸ”å¥³', text: 'å¤§å®¶å¥½ï½', time: '10:05' },
      { role: 'è°æ˜ç”·', text: 'é€™è£¡å¯ä»¥çœ‹åˆ°å…¨éƒ¨', time: '10:08' }
    ];
    localStorage.setItem('guestbook_messages', JSON.stringify(messages));
  }

  function renderCrowd() {
    // 1. é‡ç½®æ‰€æœ‰æ ¼å­çš„å…§å®¹ (åªä¿ç•™æ¨™ç±¤)
    document.querySelectorAll('.zone').forEach(z => {
      const label = z.querySelector('.zone-label');
      z.innerHTML = ''; 
      if(label) z.appendChild(label);
    });

    // 2. æ¸²æŸ“æ¯ä¸€å€‹ç•™è¨€çš„å°äºº
    messages.forEach((msg, idx) => {
      const fullRole = msg.role; 
      const adjective = fullRole.replace(/[ç”·å¥³]$/, '');
      
      let roleIndex = roleList.indexOf(adjective);
      if(roleIndex === -1) roleIndex = roleList.indexOf(fullRole);
      if(roleIndex === -1) roleIndex = 19; 

      const container = document.getElementById(`zone-${roleIndex}`);
      if(!container) return;

      const person = document.createElement('div');
      const styleIdx = roleIndex % 10; 
      person.className = `person style-${styleIdx}`;
      
      // éš¨æ©Ÿä½ç½®è¨ˆç®—
      const hash = msg.text.length + idx * 113; 
      const randX = (hash * 37 % 70) + 15; 
      const randY = (hash * 59 % 60) + 20; 
      
      person.style.left = `${randX}%`;
      person.style.top = `${randY}%`;
      person.style.zIndex = idx + 10;

      // å½±ç‰‡è·¯å¾‘
      const videoSrc = `video/${fullRole}/1.webm`;

      // æ’å…¥ HTMLï¼šå®Œå…¨é€æ˜çš„å®¹å™¨
      person.innerHTML = `
        <div class="bubble">${msg.text}</div>
        <div class="avatar-video-box">
          <video src="${videoSrc}" autoplay loop muted playsinline></video>
        </div>
      `;
      container.appendChild(person);
    });
  }

  // ==========================================
  // 4. è¼¸å…¥èˆ‡çµ±è¨ˆ
  // ==========================================
  function addMessage() {
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if(!text) return;
    
    const newMsg = {
      role: myRole, // å„²å­˜ "å½¢å®¹è©+æ€§åˆ¥"
      text: text,
      time: new Date().toLocaleTimeString()
    };
    
    messages.push(newMsg); 
    localStorage.setItem('guestbook_messages', JSON.stringify(messages));
    
    input.value = '';
    renderCrowd();
    updateStats();
  }

  document.getElementById('msg-input').addEventListener('keypress', (e)=>{
    if(e.key==='Enter') addMessage();
  });

  let chartInstance = null;
  function updateStats() {
    const counts = {};
    messages.forEach(m => { 
      const adjective = m.role.replace(/[ç”·å¥³]$/, '');
      const name = roleList.includes(adjective) ? adjective : 'å…¶ä»–';
      counts[name] = (counts[name] || 0) + 1; 
    });
    
    const ctx = document.getElementById('roleChart');
    if(chartInstance) chartInstance.destroy();
    
    const colors = ['#ff8a80', '#ffd180', '#ffff8d', '#ccff90', '#a7ffeb', '#80d8ff', '#b388ff', '#f48fb1', '#cfd8dc'];

    chartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          data: Object.values(counts),
          backgroundColor: Object.keys(counts).map((_, i) => colors[i % colors.length]),
          borderWidth: 1
        }]
      },
      options: { 
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } }
      }
    });

    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 3);
    const listEl = document.getElementById('top3-list');
    listEl.innerHTML = '';

    if(sorted.length === 0) listEl.innerHTML = '<li style="color:#999;text-align:center;">æš«ç„¡æ•¸æ“š</li>';
    else {
      sorted.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'rank-item';
        li.innerHTML = `
          <div style="display:flex; align-items:center;">
            <span class="rank-num">${index + 1}</span>
            <span class="rank-name">${item[0]}</span>
          </div>
          <span class="rank-count">${item[1]} äºº</span>
        `;
        listEl.appendChild(li);
      });
    }
  }

  // å•Ÿå‹•
  renderCrowd();
  updateStats();
// === è‡ªè¨‚é¼ æ¨™æ§åˆ¶ ===
  (function(){
    const cursor = document.getElementById('fake-cursor');
    let mouseX = -100, mouseY = -100; 
    let curX = -100, curY = -100;

    document.addEventListener('mousemove', (e) => {
      mouseX = e.clientX;
      mouseY = e.clientY;
    });

    document.addEventListener('mousedown', () => cursor.classList.add('is-clicking'));
    document.addEventListener('mouseup', () => cursor.classList.remove('is-clicking'));

    function renderCursor() {
      curX += (mouseX - curX) * 0.2;
      curY += (mouseY - curY) * 0.2;
      cursor.style.transform = `translate3d(${curX}px, ${curY}px, 0)`;
      requestAnimationFrame(renderCursor);
    }
    renderCursor();
  })();
</script>
</body>
</html>